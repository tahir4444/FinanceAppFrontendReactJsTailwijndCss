name: Frontend CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      htaccess-changed: ${{ steps.check-htaccess.outputs.changed }}
    
    steps:
      - name: ğŸ§¾ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ” Check if .htaccess Changed
        id: check-htaccess
        run: |
          # Handle case where there's no previous commit (first push)
          if [ $(git rev-list --count HEAD) -eq 1 ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ First commit detected - will deploy .htaccess"
          elif git diff --name-only HEAD~1 HEAD | grep -q "^\.htaccess$"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ .htaccess file has changed - will deploy it"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ… .htaccess unchanged - will preserve existing file"
          fi

      - name: ğŸ›  Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: âœï¸ Build Frontend for Server 2
        run: |
          rm -rf dist/
          echo "VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}" > .env
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" >> .env
          echo "FRONTEND_URL=${{ secrets.FRONTEND_URL_2 }}" >> .env
          npm run build
          mkdir -p builds/server2
          cp -r dist/* builds/server2/
          
          # FIXED: Always copy .htaccess to build directory if it exists
          if [ -f ".htaccess" ]; then
            echo "ğŸ“ Copying .htaccess to build directory"
            cp .htaccess builds/server2/.htaccess
            # Verify the file was copied
            if [ -f "builds/server2/.htaccess" ]; then
              echo "âœ… .htaccess successfully copied to build directory"
              echo "ğŸ“ File size: $(wc -c < builds/server2/.htaccess) bytes"
              echo "ğŸ“„ First 3 lines:"
              head -3 builds/server2/.htaccess || true
            else
              echo "âŒ Failed to copy .htaccess to build directory"
            fi
          else
            echo "âŒ .htaccess file not found in repository root"
          fi

      - name: ğŸ“¤ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-server2
          path: builds/server2/
          retention-days: 1

  deploy-server2:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Download Server 2 Build
        uses: actions/download-artifact@v4
        with:
          name: build-server2
          path: ./build

      - name: ğŸ” Verify Downloaded Build
        run: |
          echo "ğŸ” Verifying downloaded build contents:"
          ls -la ./build/
          if [ -f "./build/.htaccess" ]; then
            echo "âœ… .htaccess found in downloaded build"
            echo "ğŸ“ File size: $(wc -c < ./build/.htaccess) bytes"
          else
            echo "âŒ .htaccess NOT found in downloaded build"
            echo "ğŸ” Hidden files check:"
            ls -la ./build/ | grep -E "^\." || echo "No hidden files found"
          fi

      - name: ğŸ§¹ Backup and Clean Target Directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER2_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 5m
          script: |
            set -e
            TARGET_DIR="${{ secrets.SERVER2_APP_PATH }}"
            BACKUP_FILE="/tmp/htaccess_backup_$(date +%s)"
            
            echo "ğŸ§¹ Preparing target directory: $TARGET_DIR"
            
            # Backup existing .htaccess only if we're not deploying a new one
            if [ "${{ needs.build.outputs.htaccess-changed }}" != "true" ] && [ -f "$TARGET_DIR/.htaccess" ]; then
              echo "ğŸ’¾ Backing up existing .htaccess (unchanged)"
              cp "$TARGET_DIR/.htaccess" "$BACKUP_FILE"
              echo "$BACKUP_FILE" > /tmp/htaccess_backup_path
              echo "âœ… .htaccess backed up to $BACKUP_FILE"
            else
              echo "ğŸ†• .htaccess changed or new deployment - no backup needed"
              echo "" > /tmp/htaccess_backup_path
            fi
            
            # Clean target directory
            if [ -d "$TARGET_DIR" ]; then
              echo "ğŸ“ Cleaning target directory contents..."
              sudo find "$TARGET_DIR" -mindepth 1 -delete 2>/dev/null || {
                sudo rm -rf "$TARGET_DIR"/* 2>/dev/null || echo "âš ï¸ Some files couldn't be removed"
                sudo rm -rf "$TARGET_DIR"/.[^.]* 2>/dev/null || echo "âš ï¸ Some hidden files couldn't be removed"
              }
              sudo chown -R $USER:$USER "$TARGET_DIR" 2>/dev/null || echo "âš ï¸ Couldn't change ownership"
              sudo chmod -R 755 "$TARGET_DIR" 2>/dev/null || echo "âš ï¸ Couldn't change permissions"
            else
              echo "ğŸ“ Creating target directory..."
              sudo mkdir -p "$TARGET_DIR"
              sudo chown -R $USER:$USER "$TARGET_DIR"
              sudo chmod -R 755 "$TARGET_DIR"
            fi
            
            echo "âœ… Target directory prepared for deployment"

      - name: ğŸš€ Deploy Build Files to Server 2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER2_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: 'build/*,build/.*'
          target: ${{ secrets.SERVER2_APP_PATH }}
          strip_components: 1
          rm: false
          overwrite: true
          timeout: 120s

      - name: ğŸ”§ Handle .htaccess File
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER2_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 5m
          script: |
            set -e
            TARGET_DIR="${{ secrets.SERVER2_APP_PATH }}"
            
            echo "ğŸ” Current directory contents after deployment:"
            ls -la "$TARGET_DIR"
            
            # Check if .htaccess was deployed
            if [ -f "$TARGET_DIR/.htaccess" ]; then
              echo "âœ… .htaccess found in target directory"
              chmod 644 "$TARGET_DIR/.htaccess"
              chown $USER:$USER "$TARGET_DIR/.htaccess" 2>/dev/null || true
              echo "ğŸ“ .htaccess permissions set to 644"
              echo "ğŸ“„ .htaccess content (first 5 lines):"
              head -5 "$TARGET_DIR/.htaccess" 2>/dev/null || echo "Could not read .htaccess content"
              echo "ğŸ“ File size: $(wc -c < "$TARGET_DIR/.htaccess") bytes"
            else
              echo "âŒ .htaccess not found after deployment"
              
              # Try to restore from backup if we have one
              if [ "${{ needs.build.outputs.htaccess-changed }}" != "true" ]; then
                echo "â™»ï¸ Attempting to restore .htaccess from backup..."
                BACKUP_RESTORED=false
                
                if [ -f "/tmp/htaccess_backup_path" ]; then
                  BACKUP_PATH=$(cat /tmp/htaccess_backup_path 2>/dev/null || echo "")
                  if [ -n "$BACKUP_PATH" ] && [ -f "$BACKUP_PATH" ]; then
                    echo "ğŸ”„ Restoring .htaccess from: $BACKUP_PATH"
                    cp "$BACKUP_PATH" "$TARGET_DIR/.htaccess"
                    chmod 644 "$TARGET_DIR/.htaccess"
                    chown $USER:$USER "$TARGET_DIR/.htaccess" 2>/dev/null || true
                    rm "$BACKUP_PATH" "/tmp/htaccess_backup_path" 2>/dev/null || true
                    echo "âœ… .htaccess restored from backup"
                    BACKUP_RESTORED=true
                  fi
                fi
                
                if [ "$BACKUP_RESTORED" = "false" ]; then
                  echo "âš ï¸ Could not restore .htaccess from backup"
                  echo "ğŸ’¡ This might cause routing issues for your SPA"
                fi
              else
                echo "ğŸ†• .htaccess should have been deployed but is missing"
                echo "ğŸ’¡ Check if the .htaccess file exists in your repository root"
              fi
            fi

      - name: ğŸ” Reload Apache Server 2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER2_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          timeout: 90s
          command_timeout: 2m
          script: |
            echo "ğŸ”„ Reloading Apache configuration..."
            
            # Test Apache configuration first
            if sudo apache2ctl configtest 2>/dev/null; then
              echo "âœ… Apache configuration test passed"
            else
              echo "âš ï¸ Apache configuration test failed - attempting reload anyway"
            fi
            
            # Reload Apache with timeout handling
            if timeout 30 sudo systemctl reload apache2; then
              echo "âœ… Apache reloaded successfully"
            else
              echo "âš ï¸ Apache reload timed out or failed - trying restart"
              if timeout 30 sudo systemctl restart apache2; then
                echo "âœ… Apache restarted successfully"
              else
                echo "âŒ Apache restart failed"
                exit 1
              fi
            fi
            
            # Quick status check
            if sudo systemctl is-active apache2 >/dev/null 2>&1; then
              echo "âœ… Apache is running"
            else
              echo "âŒ Apache is not running"
              sudo systemctl status apache2 --no-pager -l
              exit 1
            fi

      - name: ğŸŒ Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER2_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 2m
          script: |
            set -e
            TARGET_DIR="${{ secrets.SERVER2_APP_PATH }}"
            
            echo "ğŸ” Verifying deployment..."
            echo "ğŸ“ Directory contents:"
            ls -la "$TARGET_DIR"
            
            echo "ğŸ” Checking for key files..."
            
            if [ -f "$TARGET_DIR/index.html" ]; then
              echo "âœ… index.html found"
            else
              echo "âŒ index.html not found"
              exit 1
            fi
            
            if [ -d "$TARGET_DIR/assets" ]; then
              echo "âœ… assets directory found"
            else
              echo "âŒ assets directory not found"
              exit 1
            fi
            
            echo "ğŸ” Final .htaccess status check..."
            if [ -f "$TARGET_DIR/.htaccess" ]; then
              HTACCESS_SIZE=$(wc -c < "$TARGET_DIR/.htaccess")
              echo "âœ… .htaccess file present (${HTACCESS_SIZE} bytes)"
              if [ "${{ needs.build.outputs.htaccess-changed }}" == "true" ]; then
                echo "ğŸ†• .htaccess was updated in this deployment"
              else
                echo "â™»ï¸ .htaccess was preserved from previous deployment"
              fi
            else
              echo "âŒ WARNING: .htaccess file not found"
              echo "ğŸ’¡ This may cause routing issues for your single-page application"
            fi
            
            echo "âœ… Deployment verification completed"

  deployment-summary:
    needs: [build, deploy-server2]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š Deployment Summary
        run: |
          echo "ğŸš€ Frontend Deployment Summary:"
          echo "================================"
          if [ "${{ needs.build.outputs.htaccess-changed }}" == "true" ]; then
            echo "ğŸ†• .htaccess: UPDATED with new changes"
          else
            echo "â™»ï¸ .htaccess: PRESERVED (no changes detected)"
          fi
          
          if [ "${{ needs.deploy-server2.result }}" == "success" ]; then
            echo "âœ… Deployment completed successfully"
          else
            echo "âŒ Deployment failed - check logs above"
          fi